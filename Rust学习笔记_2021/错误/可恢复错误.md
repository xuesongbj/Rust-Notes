# 可恢复错误

可恢复性（recoverable）错误通常指一种状态，比如打开文件时，没找到，应该新建。显然，最终如何处理，由调用方负责。没有异常，对于可恢复性错误，返回`Result<T, E>`对象。

```
enum Result<T, E> {
    Ok(T),
    Err(E),
}
```

`Result<T, E>` 类型定义了很多辅助方法来处理各种情况，其中之一叫做`unwrap`。如果`Result`值是成员`OK`, `unwrap`会返回`OK`中的值。如果`Result`是成员`Err`，`unwrap`会为我们调用`panic!`。


* unwrap实例

```
use std::fs::File;

fn main() {
    let _f = File::open("hello.txt").unwrap();
}
```

```
root@8d75790f92f5:~/rs/closure/src# cargo r
   Compiling closure v0.1.0 (/root/rs/closure)
    Finished dev [unoptimized + debuginfo] target(s) in 3.41s
     Running `/root/rs/closure/target/debug/closure`
thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Os { code: 2, kind: NotFound, message: "No such file or directory" }', src/main.rs:4:38
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```

```
// 详细调用栈帧
root@8d75790f92f5:~/rs/closure/src# RUST_BACKTRACE=full cargo r
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `/root/rs/closure/target/debug/closure`
thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Os { code: 2, kind: NotFound, message: "No such file or directory" }', src/main.rs:4:38
stack backtrace:
   0:     0x55e20fffef10 - std::backtrace_rs::backtrace::libunwind::trace::h25e12e0d899beba0
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/../../backtrace/src/backtrace/libunwind.rs:90:5
   1:     0x55e20fffef10 - std::backtrace_rs::backtrace::trace_unsynchronized::h70e61195d6ae3df6
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5
   2:     0x55e20fffef10 - std::sys_common::backtrace::_print_fmt::hba93ab80d779695a
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:67:5
   3:     0x55e20fffef10 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::hf092b5883b4b2e50
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:46:22
   4:     0x55e2100157fc - core::fmt::write::hf68bc350a8f2f0dc
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/fmt/mod.rs:1078:17
   5:     0x55e20fffd332 - std::io::Write::write_fmt::hf66811b1bc767436
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/io/mod.rs:1517:15
   6:     0x55e210000c45 - std::sys_common::backtrace::_print::hd425a11bfe1f20f8
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:49:5
   7:     0x55e210000c45 - std::sys_common::backtrace::print::h6d678795c1e61e13
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:36:9
   8:     0x55e210000c45 - std::panicking::default_hook::{{closure}}::h78a02a4a0dee5e7e
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:208:50
   9:     0x55e21000079a - std::panicking::default_hook::h56eb7eda02f355a7
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:225:9
  10:     0x55e2100013e1 - std::panicking::rust_panic_with_hook::hb27ea14285131c61
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:591:17
  11:     0x55e210000f27 - std::panicking::begin_panic_handler::{{closure}}::hc552fcee62aad17f
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:497:13
  12:     0x55e20ffff3cc - std::sys_common::backtrace::__rust_end_short_backtrace::hb9f0aa9a78e885a0
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:141:18
  13:     0x55e210000e89 - rust_begin_unwind
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:493:5
  14:     0x55e210014bd1 - core::panicking::panic_fmt::h12ac4570ea43d06f
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/panicking.rs:92:14
  15:     0x55e2100149f3 - core::option::expect_none_failed::h096fa60f757b7204
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/option.rs:1268:5
  16:     0x55e20ffe880b - core::result::Result<T,E>::unwrap::h23ab59a6011dd489
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/result.rs:973:23
  17:     0x55e20ffe85c1 - closure::main::hd8478034164f6203
                               at /root/rs/closure/src/main.rs:4:14
  18:     0x55e20ffe895b - core::ops::function::FnOnce::call_once::h9502039bf2f2494b
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/ops/function.rs:227:5
  19:     0x55e20ffe8c4e - std::sys_common::backtrace::__rust_begin_short_backtrace::h8a370b3ebd3460e3
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/sys_common/backtrace.rs:125:18
  20:     0x55e20ffe8571 - std::rt::lang_start::{{closure}}::ha2ec106e59c08085
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/rt.rs:66:18
  21:     0x55e210001807 - core::ops::function::impls::<impl core::ops::function::FnOnce<A> for &F>::call_once::h78040f802d89ccdc
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/core/src/ops/function.rs:259:13
  22:     0x55e210001807 - std::panicking::try::do_call::h6853cad536dd09a1
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:379:40
  23:     0x55e210001807 - std::panicking::try::h827495f03a9fbb9a
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panicking.rs:343:19
  24:     0x55e210001807 - std::panic::catch_unwind::h4bdf17571090eb17
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/panic.rs:396:14
  25:     0x55e210001807 - std::rt::lang_start_internal::h2f319c33bb013f29
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/rt.rs:51:25
  26:     0x55e20ffe8547 - std::rt::lang_start::h99110ac3c9ee18ae
                               at /rustc/cb75ad5db02783e8b0222fee363c5f63f7e2cf5b/library/std/src/rt.rs:65:5
  27:     0x55e20ffe860a - main
  28:     0x7fb5129560b3 - __libc_start_main
  29:     0x55e20ffe809e - _start
  30:                0x0 - <unknown>
```

生产环境可以对`ELF`进行`strip`处理，提升安全性。

> 枚举，可为成员绑定一个值。
>
> 如果不关心绑定值，可直接使用 is_ok、is_err 方法。
>

```
fn test(x: i32) -> Result<i32, &'static str> {
    if x > 0 { Ok(x) } else { Err("error") }
}

fn main() {
    match test(1) {
        Ok(x)  => println!("{:?}", x),
        Err(e) => println!("{:?}", e),
    }

    let _x = test(0).unwrap_or_else(|err| {  // unwrap, expect
        panic!("{:?}", err);
    });
}                                      
```

> <font color='yellow'>提示:</font>
>   
>   * 如果频繁使用该Result类型，可以考虑创建更易懂的别名。
>   * 定义具体的错误类型更合理。


### 传播

可通过 `return Err`将错误按调用堆栈传递出去。

```
fn div(x: i32, y: i32) -> Result<i32, &'static str> {
    if y != 0 { 
        Ok(x / y) 
    } else { 
        Err("divide by zero") 
    }
}

fn test(x: i32, y: i32) -> Result<i32, &'static str> {
    let z = div(x, y);
    if z.is_err() { return z; }  // 传播！

    z
}


fn main() {
    test(3, 0).unwrap();        // 处理错误！
}                                      
```

可用 `?` 操作简化传播代码。

* 要么解构出`Ok`关联值，要么`return Err`向外传播。
* 只能用于`Result<T, E>`返回值的函数。
* 隐式传播的`Err`关键值类型必须相同，或可自动转换。

&nbsp;
 
```
fn div(x: i32, y: i32) -> Result<i32, &'static str> {
    if y != 0 {
        Ok(x/ y)
    } else {
        Err("divide by zero")
    }
}

fn test(x: i32, y: i32) -> Result<i32, &'static str> {
    let z: i32 = div(x, y)?;            // z返回值为i32或者Err

    Ok(z)                               // Ok将成功值，解构为Result进行返回
}

fn main() {
    test(3, 0).unwrap();
}
```

&nbsp;

链式调用示例:

```
File.open("hello.txt")?.read_to_string(&mut s)?;
```